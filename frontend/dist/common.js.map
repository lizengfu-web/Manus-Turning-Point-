{"version":3,"file":"common.js","mappings":"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","sources":["webpack://zhuanjiao-yizhan-miniprogram/._src_api_auth.ts","webpack://zhuanjiao-yizhan-miniprogram/._src_api_config.ts","webpack://zhuanjiao-yizhan-miniprogram/._src_api_request.ts","webpack://zhuanjiao-yizhan-miniprogram/._src_store_user.ts"],"sourcesContent":["import { post } from './request';\r\nimport Taro from '@tarojs/taro';\r\nimport { TOKEN_KEY, USER_INFO_KEY, API_BASE_URL } from './config';\r\n\r\nexport interface LoginParams {\r\n  code: string;\r\n  userInfo?: {\r\n    nickName: string;\r\n    avatarUrl: string;\r\n  };\r\n}\r\n\r\nexport interface LoginResponse {\r\n  token: string;\r\n  user: {\r\n    id: number;\r\n    openId: string;\r\n    nickName: string;\r\n    avatarUrl: string;\r\n    userType: string;\r\n  };\r\n}\r\n\r\n/**\r\n * 微信登录\r\n */\r\nexport async function wxLogin(params: LoginParams): Promise<LoginResponse> {\r\n  try {\r\n    console.log('[wxLogin] Starting login with code:', params.code?.substring(0, 10) + '...');\r\n    console.log('[wxLogin] API_BASE_URL:', API_BASE_URL);\r\n    \r\n    // 使用标准 HTTP POST 请求\r\n    const response = await Taro.request({\r\n      url: `${API_BASE_URL}/auth/login`,\r\n      method: 'POST',\r\n      data: params,\r\n      header: {\r\n        'Content-Type': 'application/json',\r\n      },\r\n    });\r\n    \r\n    console.log('[wxLogin] Response status:', response.statusCode);\r\n    console.log('[wxLogin] Response data:', response.data);\r\n    \r\n    if (response.statusCode === 200 && response.data.success) {\r\n      const result = response.data.data;\r\n      \r\n      // 保存 token 和用户信息\r\n      Taro.setStorageSync(TOKEN_KEY, result.token);\r\n      Taro.setStorageSync(USER_INFO_KEY, result.user);\r\n      \r\n      console.log('[wxLogin] Login successful');\r\n      return result;\r\n    } else {\r\n      const errorMsg = response.data.error || '登录失败';\r\n      console.error('[wxLogin] Login failed:', errorMsg);\r\n      throw new Error(errorMsg);\r\n    }\r\n  } catch (error: any) {\r\n    console.error('[wxLogin] Error:', error);\r\n    throw error;\r\n  }\r\n}\r\n\r\n/**\r\n * 获取当前用户信息\r\n */\r\nexport function getCurrentUser() {\r\n  return Taro.getStorageSync(USER_INFO_KEY);\r\n}\r\n\r\n/**\r\n * 退出登录\r\n */\r\nexport function logout() {\r\n  Taro.removeStorageSync(TOKEN_KEY);\r\n  Taro.removeStorageSync(USER_INFO_KEY);\r\n  Taro.reLaunch({ url: '/pages/index/index' });\r\n}\r\n\r\n/**\r\n * 检查是否已登录\r\n */\r\nexport function isLoggedIn(): boolean {\r\n  const token = Taro.getStorageSync(TOKEN_KEY);\r\n  return !!token;\r\n}\r\n\r\n/**\r\n * 获取用户信息\r\n */\r\nexport async function getUserInfo() {\r\n  try {\r\n    const token = Taro.getStorageSync(TOKEN_KEY);\r\n    if (!token) {\r\n      throw new Error('未登录');\r\n    }\r\n\r\n    const response = await Taro.request({\r\n      url: `${API_BASE_URL}/auth/user`,\r\n      method: 'GET',\r\n      header: {\r\n        'Authorization': `Bearer ${token}`,\r\n      },\r\n    });\r\n\r\n    if (response.statusCode === 200 && response.data.success) {\r\n      return response.data.data;\r\n    } else {\r\n      throw new Error(response.data.error || '获取用户信息失败');\r\n    }\r\n  } catch (error: any) {\r\n    console.error('获取用户信息错误:', error);\r\n    throw error;\r\n  }\r\n}\r\n\r\n/**\r\n * 编辑用户信息\r\n */\r\nexport async function updateUserInfo(userInfo: {\r\n  nickName?: string;\r\n  avatarUrl?: string;\r\n  userType?: string;\r\n  province?: string;\r\n  city?: string;\r\n  workYears?: number;\r\n}) {\r\n  try {\r\n    const token = Taro.getStorageSync(TOKEN_KEY);\r\n    if (!token) {\r\n      throw new Error('未登录');\r\n    }\r\n\r\n    const response = await Taro.request({\r\n      url: `${API_BASE_URL}/auth/user/update`,\r\n      method: 'POST',\r\n      data: userInfo,\r\n      header: {\r\n        'Authorization': `Bearer ${token}`,\r\n        'Content-Type': 'application/json',\r\n      },\r\n    });\r\n\r\n    if (response.statusCode === 200 && response.data.success) {\r\n      // 更新本地存储\r\n      const updatedUser = response.data.data;\r\n      Taro.setStorageSync(USER_INFO_KEY, updatedUser);\r\n      return updatedUser;\r\n    } else {\r\n      throw new Error(response.data.error || '编辑用户信息失败');\r\n    }\r\n  } catch (error: any) {\r\n    console.error('编辑用户信息错误:', error);\r\n    throw error;\r\n  }\r\n}\r\n","// API 配置\r\n// 本地开发：使用本地 IP 地址（不能使用 localhost）\r\n// 请将 YOUR_LOCAL_IP 替换为您电脑的局域网 IP 地址\r\nexport const API_BASE_URL = 'http://192.168.31.20:8080/api';\r\nexport const WEB_BASE_URL = 'http://192.168.31.20:8080';\r\n\r\n// 请求超时时间\r\nexport const REQUEST_TIMEOUT = 30000;\r\n\r\n// Token 存储 key\r\nexport const TOKEN_KEY = 'auth_token';\r\n\r\n// 用户信息存储 key\r\nexport const USER_INFO_KEY = 'user_info';\r\n","import Taro from '@tarojs/taro';\r\nimport { API_BASE_URL, REQUEST_TIMEOUT, TOKEN_KEY } from './config';\r\n\r\ninterface RequestOptions {\r\n  url: string;\r\n  method?: 'GET' | 'POST' | 'PUT' | 'DELETE';\r\n  data?: any;\r\n  header?: any;\r\n  showLoading?: boolean;\r\n  loadingText?: string;\r\n}\r\n\r\ninterface Response<T = any> {\r\n  code: number;\r\n  data: T;\r\n  message: string;\r\n}\r\n\r\n/**\r\n * 网络请求封装\r\n */\r\nexport async function request<T = any>(options: RequestOptions): Promise<T> {\r\n  const {\r\n    url,\r\n    method = 'GET',\r\n    data,\r\n    header = {},\r\n    showLoading = false,\r\n    loadingText = '加载中...'\r\n  } = options;\r\n\r\n  // 显示加载提示\r\n  if (showLoading) {\r\n    Taro.showLoading({ title: loadingText, mask: true });\r\n  }\r\n\r\n  try {\r\n    // 获取 token\r\n    const token = Taro.getStorageSync(TOKEN_KEY);\r\n\r\n    // 发起请求\r\n    const response = await Taro.request({\r\n      url: `${API_BASE_URL}${url}`,\r\n      method,\r\n      data,\r\n      header: {\r\n        'Content-Type': 'application/json',\r\n        'Authorization': token ? `Bearer ${token}` : '',\r\n        ...header\r\n      },\r\n      timeout: REQUEST_TIMEOUT\r\n    });\r\n\r\n    // 隐藏加载提示\r\n    if (showLoading) {\r\n      Taro.hideLoading();\r\n    }\r\n\r\n    const result = response.data as Response<T>;\r\n\r\n    // 处理响应\r\n    if (response.statusCode === 200) {\r\n      if (result.code === 0 || result.code === 200) {\r\n        return result.data;\r\n      } else if (result.code === 401) {\r\n        // 未登录或 token 失效\r\n        Taro.removeStorageSync(TOKEN_KEY);\r\n        Taro.showToast({\r\n          title: '请先登录',\r\n          icon: 'none',\r\n          duration: 2000\r\n        });\r\n        // 跳转到登录页\r\n        setTimeout(() => {\r\n          Taro.reLaunch({ url: '/pages/index/index' });\r\n        }, 2000);\r\n        throw new Error('未登录');\r\n      } else {\r\n        Taro.showToast({\r\n          title: result.message || '请求失败',\r\n          icon: 'none',\r\n          duration: 2000\r\n        });\r\n        throw new Error(result.message || '请求失败');\r\n      }\r\n    } else {\r\n      Taro.showToast({\r\n        title: '网络请求失败',\r\n        icon: 'none',\r\n        duration: 2000\r\n      });\r\n      throw new Error('网络请求失败');\r\n    }\r\n  } catch (error: any) {\r\n    // 隐藏加载提示\r\n    if (showLoading) {\r\n      Taro.hideLoading();\r\n    }\r\n\r\n    // 处理错误\r\n    console.error('API 请求错误:', error);\r\n    \r\n    if (error.errMsg) {\r\n      if (error.errMsg.includes('timeout')) {\r\n        const timeoutError = new Error('请求超时，请检查网络');\r\n        throw timeoutError;\r\n      } else if (error.errMsg.includes('fail')) {\r\n        // 提供更详细的错误信息\r\n        let errorMsg = '网络连接失败';\r\n        if (error.errMsg.includes('request:fail')) {\r\n          errorMsg = '无法连接到服务器，请检查：\\n1. 网络连接\\n2. 服务器地址配置\\n3. 微信开发者工具中关闭域名校验';\r\n        }\r\n        const failError = new Error(errorMsg);\r\n        throw failError;\r\n      }\r\n    }\r\n\r\n    throw error;\r\n  }\r\n}\r\n\r\n/**\r\n * GET 请求\r\n */\r\nexport function get<T = any>(url: string, data?: any, showLoading = false): Promise<T> {\r\n  return request<T>({ url, method: 'GET', data, showLoading });\r\n}\r\n\r\n/**\r\n * POST 请求\r\n */\r\nexport function post<T = any>(url: string, data?: any, showLoading = false): Promise<T> {\r\n  return request<T>({ url, method: 'POST', data, showLoading });\r\n}\r\n\r\n/**\r\n * PUT 请求\r\n */\r\nexport function put<T = any>(url: string, data?: any, showLoading = false): Promise<T> {\r\n  return request<T>({ url, method: 'PUT', data, showLoading });\r\n}\r\n\r\n/**\r\n * DELETE 请求\r\n */\r\nexport function del<T = any>(url: string, data?: any, showLoading = false): Promise<T> {\r\n  return request<T>({\r\n    url,\r\n    method: 'DELETE',\r\n    data,\r\n    showLoading\r\n  });\r\n}\r\n\r\n/**\r\n * tRPC 请求封装（支持 mutation）\r\n */\r\nexport async function trpcMutation<T = any>(procedure: string, input: any, showLoading = false): Promise<T> {\r\n  if (showLoading) {\r\n    Taro.showLoading({ title: '加载中...', mask: true });\r\n  }\r\n\r\n  try {\r\n    const token = Taro.getStorageSync(TOKEN_KEY);\r\n    \r\n    // tRPC 使用 batch 格式\r\n    const response = await Taro.request({\r\n      url: `${API_BASE_URL}/api/trpc/${procedure}?batch=1`,\r\n      method: 'POST',\r\n      data: { \"0\": input },\r\n      header: {\r\n        'Content-Type': 'application/json',\r\n        'Authorization': token ? `Bearer ${token}` : '',\r\n      },\r\n      timeout: REQUEST_TIMEOUT\r\n    });\r\n\r\n    if (showLoading) {\r\n      Taro.hideLoading();\r\n    }\r\n\r\n    if (response.statusCode === 200) {\r\n      const result = response.data as any;\r\n      // tRPC batch 响应格式是数组\r\n      if (Array.isArray(result) && result[0]) {\r\n        const firstResult = result[0];\r\n        if (firstResult.result && firstResult.result.data) {\r\n          return firstResult.result.data.json || firstResult.result.data;\r\n        } else if (firstResult.error) {\r\n          throw new Error(firstResult.error.message || '请求失败');\r\n        }\r\n      }\r\n      return result;\r\n    } else {\r\n      throw new Error(`HTTP ${response.statusCode}`);\r\n    }\r\n  } catch (error: any) {\r\n    if (showLoading) {\r\n      Taro.hideLoading();\r\n    }\r\n    console.error('tRPC 请求错误:', error);\r\n    throw error;\r\n  }\r\n}","import { create } from 'zustand';\r\n\r\ninterface User {\r\n  id: number;\r\n  openId: string;\r\n  nickName: string;\r\n  avatarUrl: string;\r\n  userType: string;\r\n}\r\n\r\ninterface UserStore {\r\n  user: User | null;\r\n  isLoggedIn: boolean;\r\n  setUser: (user: User | null) => void;\r\n  clearUser: () => void;\r\n}\r\n\r\nexport const useUserStore = create<UserStore>((set) => ({\r\n  user: null,\r\n  isLoggedIn: false,\r\n  setUser: (user) => set({ user, isLoggedIn: !!user }),\r\n  clearUser: () => set({ user: null, isLoggedIn: false })\r\n}));\r\n"],"names":[],"ignoreList":[],"sourceRoot":""}